# Sudo 힙 오버플로우를 이용한 권한 상승 취약점

### Author

---

김순욱

### Date

---

2021.02.03

### Summary

---

Qualys 연구팀이 발표한 **sudo**에서 발견된 **권한 상승 취약점**(`CVE-2021–3156`)은 **힙 오버플로우**(Heap Overflow)를 기반으로 하며, exploit 성공 시 관리자 권한을 획득할 수 있다. exploit 코드는 C와 Python 2가지 언어의 버전으로 explot-db에 공개된 상태이며, 코드가 공개되기 전에 sudo의 보안 패치가 배포되었다.

### Keywords

---

#CVE-2021–3156 #Sudo #Heap_Overflow #Privilege_Escalation_Vulnerability

### Root Cause

---

`CVE-2021–3156` 취약점이 존재하는 sudo의 소스코드에는 파라미터로 백슬래시(\) 문자열을 입력하여 힙 오버플로우 취약점을 발생시킬 수 있는 코드가 존재한다.

| 플래그 | MODE_SHELL | MODE_RUN | MODE_CHECK | MODE_EDIT |
| --- | --- | --- | --- | --- |
| 옵션 | s | - | l | e |

해당 코드에 접근하기 위해서, sudo 실행 시 위 표처럼 옵션이 설정되어 있어야 하지만, 이 옵션들은 동시에 설정될 수 없도록 구현되어 있어 일반적인 `sudo` 명령으로는 취약점 공격이 불가능하다.

하지만 sudo를 `sudo` 명령어가 아닌 `sudoedit` 명령어로 실행 시, 프로그램 내부에서 자동으로 `-e` 옵션이 적용되면서, `sudoedit -s` 명령 실행 시 `sudo -e -s` 옵션을 적용한 것과 동일한 실행이 가능하기 때문에 취약점이 존재하는 루틴에 접근 가능하다.

![[그림 1] sudo 명령 실행 후 취약점이 존재하는 루틴에 진입하는 과정](https://github.com/IHHH-official/Vulnerability-Research/assets/48719589/88bc9219-6497-41bf-b52b-fcce5db57843)

[그림 1] sudo 명령 실행 후 취약점이 존재하는 루틴에 진입하는 과정

`sudo` 명령을 실행한 후 2개의 조건식을 거치게 되며, 이 조건식들은 `sudo` 명령 실행 시 사용된 옵션(플래그) 설정 여부를 확인한다. 이 조건식들을 모두 만족할 경우 힙 오버플로우 취약점이 존재하는 루틴에 최종 진입하게 된다.

![[그림 2] set_cmnd() 함수 내 힙 오버플로우 취약점이 존재하는 루틴](https://github.com/IHHH-official/Vulnerability-Research/assets/48719589/33b63100-23e9-41e5-9486-00c0043a260f)

[그림 2] set_cmnd() 함수 내 힙 오버플로우 취약점이 존재하는 루틴

위 소스코드는 sudo 1.8.31버전의 소스코드 `sudoers.c` 파일 내 취약점이 존재하는 `set_cmnd()` 함수의 내용이다. 이 함수에서 백슬래시(\)를 처리하는 과정에서 힙 오버플로우가 발생하는데, 그 과정은 다음과 같다.

1. *866*번 줄의 백슬래시(\) 이스케이프를 해제하는 로직에 접근하게 될 때 from 포인터 변수가 가리키는 백슬래시(\) 문자열 뒤에 NULL 문자열이 위치하게 됨
2. *867*번 줄에서 이스케이프를 진행하기 위해 from 변수를 증감하여 백슬래시(\) 문자열 뒤에 존재하는 NULL 문자열을 가리키게 되고, *868*번 줄에서 from 변수가 한번 더 증감되면서 NULL 문자열 뒤의 임의의 값을 읽게 됨
3. 2번에 의해 증감 연산이 총 두 번 진행되어 NULL 문자열을 건너뛰게 됨으로써 *865*번 줄의 while 문 조건식을 무시하게 되고, *853*번 줄에서 계산한 힙 메모리의 크기를 벗어나 임의의 값을 계속 입력할 수 있게 됨 → ***힙 오버플로우** 발생!*

![[그림 3] 취약점이 존재하는 루틴에 진입하기 위한 조건들](https://github.com/IHHH-official/Vulnerability-Research/assets/48719589/8511a226-e6f9-4b14-9919-eb537844af43)

[그림 3] 취약점이 존재하는 루틴에 진입하기 위한 조건들

위 소스코드는 [그림 1]의 “Section 2”에 해당하는 루틴이다. 취약한 코드에 진입하기 위해 2개의 조건식을 만족해야하는데, 하나는 *MODE_RUN*, *MODE_EDIT*(`-e`), *MODE_CHECK*(`-l`) 플래그 중 1개의 플래그가 설정되어야 하는 것이며, 다른 하나는 *MODE_SHELL*(`-s`), *MODE_LOGIN_SHELL* 플래그가 설정되어야 하는 것이다. `sudo` 명령으로는 위에서 체크하는 플래그(옵션)들을 동시에 설정할 수 없도록 되어있기 때문에, 일반적인 `sudo` 명령을 활용한 취약점 공격은 불가능하다. 

![[그림 4] sudoedit 명령어로 sudo 실행 시 설정되는 플래그](https://github.com/IHHH-official/Vulnerability-Research/assets/48719589/ba39c8f0-a0cb-41b8-968d-08ccaada6a23)

[그림 4] sudoedit 명령어로 sudo 실행 시 설정되는 플래그

그러나, `sudoedit` 명령어를 실행하는 경우, 기본적으로 *MODE_SHELL*(`-s`) 플래그와 *MODE_EDIT*(`-e`) 플래그가 설정되므로, 조건들을 모두 만족하고 취약점이 존재하는 루틴으로 진입할 수 있다. 따라서 `sudoedit` 명령어로 “`sudoedit -s <임의의 문자열>`”과 같은 페이로드를 활용한 힙 오버플로우 취약점 공격이 가능하게 된다!

### Exploit

---

현재 이 취약점의 exploit 코드는 Qualys 연구팀에서 C와 Python으로 제작한 2개의 코드를 exploit-db에 공개해 확인해볼 수 있으며, 두 코드의 exploit 과정은 동일하다.
[Sudo 1.9.5p1 – 'Baron Samedit ' Heap-Based Buffer Overflow Privilege Escalation](https://www.exploit-db.com/exploits/49521)

![[그림 5] 조작된 passwd 파일이 공격에 활용되는 과정](https://github.com/IHHH-official/Vulnerability-Research/assets/48719589/c96aa5eb-1514-4d49-bec2-4d66e863a0aa)

[그림 5] 조작된 passwd 파일이 공격에 활용되는 과정

exploit 코드에서 `-source` 옵션으로 대상 일반유저의 uid와 gid의 값을 0으로 수정한 passwd 파일을 파라미터로 전달받으며, 이 파일의 내용을 `/etc/passwd` 파일에 덮어써서 최종적으로 root 권한을 획득하게 된다.

### Solution

---

1. systemtap 스크립트 활용
    - `systemtap` 스크립트를 활용하여 `sudoedit` 명령어의 실행 차단 가능
    - 스크립트를 실행하면 `sudoedit` 명령은 사용 불가능하고, 기존 `sudoedit`의 기능은 `sudo -e` 명령어로 대체 가능
2. 보안 업데이트
    
    
    | No | 취약한 버전 | 보안 패치 버전 | 패치 일자 |
    | --- | --- | --- | --- |
    | 1 | 1.8.2 ~ 1.8.31p2 | 1.8.32 | 2021-02-09 |
    | 2 | 1.9.0 ~ 1.9.5p1 | 1.9.5p2 | 2021-01-26 |
    - 위 표에서 sudo가 취약한 버전에 해당하는 경우, 보안 패치가 배포된 최신 버전으로 업데이트가 필요함
    

### Reference

---

[Sudo 취약점 분석 및 대응방안 part.2](https://www.igloo.co.kr/security-information/sudo-취약점-분석-및-대응방안-part-2/)

[NVD - CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)