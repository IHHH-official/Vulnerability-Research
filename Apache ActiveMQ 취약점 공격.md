# ****Apache ActiveMQ 취약점 공격****

### Author

---

김순욱

### Date

---

2023.10.24

### Summary

---

`CVE-2023-46604`는 오픈 소스 메시징 및 통합 패턴 서버인 **Apache ActiveMQ** 서버의 **원격 코드 실행(RCE) 취약점**이다. 만약 패치되지 않은 Apache ActiveMQ 서버가 외부에 노출되어 있을 경우 공격자는 원격에서 악의적인 명령을 실행하여 해당 시스템을 장악할 수 있다.

공격자들은 패치되지 않은 취약한 Apache ActiveMQ 서비스를 대상으로 지속적으로 공격을 수행하고 있다. 시스템 관리자는 사용 중인 Apache ActiveMQ 서비스가 취약한 버전인지 점검하고 최신 버전으로 패치해 기존에 알려진 취약점으로부터 공격을 방지해야 한다.

### Keywords

---

#CVE-2023-46604 #Apache #ActiveMQ #Remote_Code_Execution_Vulnerability #RCE #AMQ-9370

### Root Cause

---

취약점 공격은 classpath에 있는 클래스를 인스턴스화하도록 OpenWire 프로토콜에서 직렬화된 클래스 유형을 조작하여 임의의 쉘 명령을 실행하는 방식으로 이루어진다. 

![Untitled](https://github.com/IHHH-official/Vulnerability-Research/assets/48719589/a5d4fc9a-be9c-4feb-81be-d1324d5f1295)

패치된 결과를 보면, validateIsThrowable 메서드가 BaseDataStreamMarshall 클래스에 포함된 것을 확인할 수 있다.

![Untitled](https://github.com/IHHH-official/Vulnerability-Research/assets/48719589/44d9880b-8e32-479a-80a7-e277293d66d6)

Throwable의 클래스 타입을 검증하지 못하는 경우, 임의의 클래스의 인스턴스를 실수로 생성하고 실행할 수 있다. 이로 인해 공격자가 서버나 응용 프로그램에서 임의 코드를 실행할 수 있는 RCE 취약성이 발생할 수 있다. 따라서 이렇게 Throwable의 클래스 타입을 항상 검증하여 이러한 잠재적인 보안 위험을 방지해야 한다.

### Exploit

---

이 취약점 정보가 공개된 이후, 다양한 공격자들이 이를 악용해 악성코드를 유포하고 있다.  Kinsing의 경우, 이 취약점을 이용해 암호화폐 채굴기 및 악성코드를 다운로드하고 실행는 데에 악용하고 있다.

![Untitled](https://github.com/IHHH-official/Vulnerability-Research/assets/48719589/8bbf672c-3c9f-4122-a0b4-2be5bb197e1f)

ProcessBuilder 메서드를 이용해 공격하는 코드다. 

![Untitled](https://github.com/IHHH-official/Vulnerability-Research/assets/48719589/f17ac918-9c69-4843-905e-e24a2d178301)

공격이 성공하면 채굴기와 악성 설치 프로그램을 다운로드한 다음 bash를 사용해 악성 스크립트를 실행한다.

![Untitled](https://github.com/IHHH-official/Vulnerability-Research/assets/48719589/74ba186c-bbff-4cd0-b765-bd69ee358a71)

bash 스크립트가 실행되면 Kinsing 멀웨어는 C&C 서버에서 추가 바이너리와 페이로드를 다운로드 한다.

![Untitled](https://github.com/IHHH-official/Vulnerability-Research/assets/48719589/15cb861a-812a-49ec-8b1e-c1cc1e362e5c)

특이하게, Kinsing은 경쟁 암호화폐 채굴자를 적극적으로 찾아내 프로세스 및 네트워크 연결을 중단한다. 그리고 감염된 호스트의 crontab에서 경쟁 멀웨어와 채굴기를 제거한다.

![Untitled](https://github.com/IHHH-official/Vulnerability-Research/assets/48719589/d7d3c697-d8cd-4bad-8bbb-421117ba0783)

그런다음 Kinsing 바이너리에 리눅스 환경변수가 할당되어 실행된다.

![Untitled](https://github.com/IHHH-official/Vulnerability-Research/assets/48719589/7b7364a0-e6c0-42d8-a108-76ce07549a66)

마지막으로 Kinsing은 cronjob을 추가하여 매분마다 악성 부트스트랩 스크립트를 다운로드하고 실행한다. 이렇게 함으로써 영향을 받는 호스트에 대한 지속성이 보장되고, 최신 악성 Kinsing 바이너리를 사용할 수 있게 된다.

![Untitled](https://github.com/IHHH-official/Vulnerability-Research/assets/48719589/9190e026-ee49-4422-b2a6-74e4e9005f6c)

Kinsing은 루트킷을 /etc/ld.so.preload에 로드함으로써 지속성과 합의를 2배로 줄여 전체 시스템 합의를 완성한다.

### Reference

---

[지속적인 공격 대상이 되고 있는 Apache ActiveMQ 취약점 (CVE-2023-46604) - ASEC BLOG](https://asec.ahnlab.com/ko/59786/)

[Andariel 그룹의 Apache ActiveMQ 취약점 (CVE-2023-46604) 공격 정황 - ASEC BLOG](https://asec.ahnlab.com/ko/59130/)

[NVD - CVE-2023-46604](https://nvd.nist.gov/vuln/detail/CVE-2023-46604#vulnCurrentDescriptionTitle)

[CVE -
CVE-2023-46604](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-46604)

[Suspected Exploitation of Apache ActiveMQ CVE-2023-46604 | Rapid7 Blog](https://www.rapid7.com/blog/post/2023/11/01/etr-suspected-exploitation-of-apache-activemq-cve-2023-46604/)

[[AMQ-9370] Openwire marshaller should validate Throwable class type - ASF JIRA](https://issues.apache.org/jira/browse/AMQ-9370)

[CVE-2023-46604 (Apache ActiveMQ) Vulnerability Exploited to Infect Systems With Cryptominers and Rootkits](https://www.trendmicro.com/en_us/research/23/k/cve-2023-46604-exploited-by-kinsing.html)