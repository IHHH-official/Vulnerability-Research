# Microsoft Office Outlook 권한 상승 취약점

### Author

---

김순욱

### Date

---

2023.03.14

### Summary

---

Microsoft는 Windows용 Outlook의 취약점(`CVE-2023-23397`)이 NTLM 자격 증명을 탈취하는 데 악용되고 있음을 발견하였다. CVSS 점수 또한 그 심각성을 고려해 이례적으로 높은 점수인 9.8점을 부여하였다.

### Keywords

---

#CVE-2023-23397 #Microsoft #Outlook #Privilege_Escalation_Vulnerability  #CWE-294

### Root Cause

---

**Microsoft Outlook**의 캘린더에는 다음과 같이 약속한 일정을 사용자에게 알려주는 “**미리 알림**” 기능이 존재한다. 

![Outlook 미리 알림 기능](https://github.com/IHHH-official/Vulnerability-Research/assets/48719589/06ebc2e0-6aa6-4e4d-931c-3c1ec88fcfa6)

Outlook 미리 알림 기능

이때 약속 기한이 지나 지연 알림을 할 때 클라이언트는 사운드를 재생하는데, **MAPI**(Messaging Application Program Interface)의 `PidLidReminderFileParameter` 프로퍼티에서 사운드 파일의 경로(**UNC**; Universal Naming Convention)를 지정한다. `PidLidReminderOverride` 프로퍼티는 `PidLidReminderFileParameter`의 값을 신뢰할 것인지 설정한다.

![악성 msg를 만드는 PoC 코드](https://github.com/IHHH-official/Vulnerability-Research/assets/48719589/0709fd5b-6d06-4d8f-86b0-36482b285cf4)

악성 msg를 만드는 PoC 코드

위 PoC 코드에서 `PidLidReminderFileParameter` 값은 공격자가 제어 가능한 **SMB 서버 주소**이고, `PidLidReminderOverride` 값을 ***true***로 설정되어있다.

이 메일을 수신받은 Outlook은 “미리 알림” 기능을 사용할 때 공격자로부터 변조된 경로로 사운드 파일을 가져오게 된다. 이때, 경로는 공격자의 SMB 서버로 지정되어 있어 사용자의 PC는 공격자의 SMB 서버에 강제적으로 NTLM 인증을 하게 된다. 이렇게 공격자는 사용자의 **NTLM 인증정보(해시)를 탈취**해 NTLM 인증을 사용하는 시스템과 어플리케이션에 탈취한 인증정보를 이용하여 접속할 수 있게 된다.

Microsoft의 3월 정기 보안 업데이트 이전의 모든 Windows용 Microsoft Outlook 전 제품이 이 취약점에 영향을 받으며, 다른 OS나 웹용 Outlook 및 기타 Microsoft 365 서비스는 영향을 받지 않는다. 현재는 업데이트를 통해 패치되었다.

### Exploit

---

이 취약점은 우크라이나의 CERT-UA에 의해 발견되어 MS에 보고되었다. MS에 따르면 러시아 기반의 위협 행위자들이 정부, 교통, 에너지, 군사 분야의 여러 유럽 조직을 대상으로 표적 공격을 행사하며 이 취약점을 악용했다고 한다. 

이 공격의 배후에 있는 해킹 그룹은 러시아 연방군 총참모부 주국장과 연관된 위협 행위자인 **APT28**로 추정된다.

2022년 12월까지 발생한 공격을 포함해 최대 15개의 조직이 이 취약점으로 표적이 되거나 공격된 것으로 추정된다. 권한을 얻은 후, 해커들은 Impacket과 PowerShell Empire 오픈 소스 프레임워크를 사용해 정보를 수집하기 위해 네트워크의 더 가치있는 시스템으로 이동하는 경우가 많았다.

### Reference

---

[Microsoft Office Outlook 권한 상승 취약점 주의 (CVE-2023-23397) - ASEC BLOG](https://asec.ahnlab.com/ko/49819/)

[NVD - cve-2023-23397](https://nvd.nist.gov/vuln/detail/cve-2023-23397)

[Security Update Guide - Microsoft Security Response Center](https://msrc.microsoft.com/update-guide/en-us/advisory/CVE-2023-23397)

[CWE - CWE-294: Authentication Bypass by Capture-replay (4.13)](https://cwe.mitre.org/data/definitions/294.html)

[Critical Microsoft Outlook bug PoC shows how easy it is to exploit](https://www.bleepingcomputer.com/news/security/critical-microsoft-outlook-bug-poc-shows-how-easy-it-is-to-exploit/)