# Node Kakao Premalink

## 발생일자

2021.11.21

## Summary

한 사용자가 오픈소스로 만든 카카오톡 봇인 NodeKakao을 카카오톡이 사용하는 LoCo protocol(로코 프로토콜)을 리버싱하여 오픈채팅방 참여자의 카카오톡 프로필 ID, 카카오톡 로그인 시 사용되는 이메일 주소, 전화번호 등 개인정보 유출이 가능해졌다.

## Keyword

#KakaoTalk #reversing #LoCoProtocol #opensorce

## Root Cause

- LoCo Protocol

  - 2011년 10월에 *겁나 빠른 황소 프로젝트*에서 제작된 프로토콜
  - 카카오톡 메세징의 scalability와 속도 높이기 위해 TCP layer 위에 작동하는 카카오 자체 request and response 프로토콜을 통해 패킷 사이즈 경량화와 빠른 응답 얻음
    - 일반적으로 TCP 세그먼트는 40 bytes로 크기가 크며 이를 해결하기 위해 Nagel 알고리즘을 사용할 수도 있지만 해당 알고리즘은 세그먼트의 최대 크기가 될때까지 버퍼에 저장해두고 최대 크기가 되면 전송하기 때문에 크기가 작은 메세지들은 전송에 오래 걸린다. 이는 카카오톡 서비스에는 적합하지 않다
    - LoCo 프로토콜에서는 위와 같은 문제를 해결하기 위해 최소로 필요한 데이터만 추가하여 LoCoPacket을 만들었다.
    - LocoSecureNoramlPacket은 4 bytes의 encrypted Data-Block Length와 AES Encrypted Body Contensts로 구성되어 LoCoPacket보다 훨씬 간단한 구조이다.
    - LocoSecureHandShakePacket은 3가지 패킷 중 가장 중요한 패킷으로, LoCo 커맨드 사용을 위한 LoCo 서버와 통신하여 세션을 열 때 사용하는 Login 커맨드를 서버에 보낸다. 구조는 Encrypted Data-Block Length(4 bytes), Handshake Type(4 bytes), Encrypt Type(4 bytes), Encrypted Data로 되어있다. Login 커맨드를 보낼때는 handshake 패킷 앞에 붙여서 보내고, 용도는 AES 암호화에 사용될 대칭키를 서버에 전달하는 역할을 한다.

-

## Exploit

- Node Kakao
  - API를 호출해 패킷에 특정 명령어를 보내면 API가 DB에서 호출한 사람이 원하는 정보를 찾아 응답할 수 있게 됨
  - 오픈채팅방 참여자들의 IP주소를 공격자는 얻을 수 있게 되고 이를 통해 사용자의 개인정보 탈취
  - 특정 명령어를 통해 오픈채팅방에 도배, 테러, 방 폭파 등 가능해짐

## References

[node-kakao 깃허브](https://github.com/storycraft/node-kakao?tab=readme-ov-file) <br>
[node-kako 프로젝트 중단 이슈](https://github.com/storycraft/node-kakao/issues/812)<br>
[LoCo 프로토콜 분석](https://www.bpak.org/blog/2012/12/kakaotalk-loco-%ED%94%84%EB%A1%9C%ED%86%A0%EC%BD%9C-%EB%B6%84%EC%84%9D-1/)<br>
[LoCo Protocol 요약](https://lugan1.github.io/%ED%86%A0%EC%9D%B4%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8/loco_protocol/)<br>
[관련 기사](https://www.hankyung.com/article/202303148352i)<br>
[LoCo Protocol 사건사고](https://gall.dcinside.com/mgallery/board/view/?id=kakao&no=27250)
