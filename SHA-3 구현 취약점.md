# SHA-3 구현 취약점

### Author

---

김순욱

### Date

---

2022.10.20

### Summary

---

최근 **SHA-3**의 구현에서 버퍼 오버플로우 취약점(`CVE-2022–37454`)이 발견되었다. **Keccak XKCP SHA-3** 구현에서 발견되었으며, 정수 오버플로우와 그로 인한 스택 메모리 버퍼 오버플로우 취약점으로 2011년 1월부터 존재해온 것으로 알려졌다. Python, PHP 등의 스크립트 언어를 포함해 해당 코드가 포함된 모든 소프트웨어 프로젝트에 영향을 미치며 최악의 경우 임의 코드 실행, 또는 암호 관련 로직 우회까지 이어질 수도 있다. 2022년 8월, 널리 사용되는 프로젝트들에서는 취약점이 발견된 구현체들에 대한 패치가 적절하게 이루어져 최신 버전의 SHA-3에서는 더이상 해당 취약점이 발생하지 않는다.

### Keywords

---

#CVE-2022–37454 #SHA-3 #Keccak #hash_function #Buffer_Overflow #Integer_Overflow #CWE-190

### Root Cause

---

이 취약점(`CVE-2022–37454`)은 공식 **SHA-3**의 구현인 **XKCP**(eXtended Keccak Code Package)에 영향을 미친다. 또한 파이썬 및 PHP 스크립트 언어와 같은 이 코드를 포함하는 다양한 프로젝트들에도 영향을 미친다. 

취약한 버전의 구현은 다음과 같은 파이썬 스크립트에서 **세그멘테이션 폴트**를 발생시킨다.

```python
import hashlib
h = hashlib.sha3_224()
h.update(b"\x00" * 1)
h.update(b"\x00" * 4294967295)
print(h.hexdigest())
```

PHP코드는 다음과 같다.

```php
<?php
$ctx = hash_init("sha3-224");
hash_update($ctx, str_repeat("\x00", 1));
hash_update($ctx, str_repeat("\x00", 4294967295));
echo hash_final($ctx);
?>
```

세그멘테이션 폴트의 발생 원인은, 스크립트가 보유할 수 있는 것보다 더 많은 데이터를 버퍼에 기록하려고 시도하기 때문이다. 즉  **버퍼 오버플로우**를 발생시키며, 이는 OWASP(Open Web Application Security Project)에서 설명하는 “가장 잘 알려진 소프트웨어 보안 취약성”이다.

위 코드에서 4294967295를 4294967296으로 바꾸는 작은 변형으로 무한 루프가 발생된다. 이러한 동작은 파이썬이나 PHP와 같은 언어에서는 모든 읽기 및 쓰기 작업이 버퍼의 크기 내에 있는지 확인하기 때문에 안전하지만, 그렇지 않은 C언어의 경우 안전하지 않다.

이 취약점은 2011년 1월 Keccak의 최종 업데이트가 NIST SHA-3 해시 함수 대회에 제출된 이후부터 존재해왔으니 발견되기까지 10년이 걸린 셈이다. 이러한 암호화 구현 컴포넌트에 존재하는 취약점을 찾는 것이 시스템의 전반적인 보안에 중요함에도 시간이 오래 걸린 것은, 버그 바운티 프로그램에 이러한 취약점들이 그 대상이 되지 않기 때문으로 보인다.

### Exploit

---

이 취약점을 이용하는 공격자는 해시 함수의 암호 속성을 위반해 프리이미지, 세컨드 프리이미지, 충돌 등을 생성할 수 있다. 또한, 특수하게 제작된 파일을 통해 임의 코드를 실행할 수 있으며, 동일하게 SHA-3를 사용해야하는 **Ed448**과 같은 서명 검증 알고리즘에도 영향을 미칠 수 있다.

### Reference

---

[2023 Hot🔥 보안 사건 사고 — 상반기](https://blog.theori.io/2023-h1-hot-security-issue-case-84eac2942176)

[A Vulnerability in Implementations of SHA-3, SHAKE, EdDSA, and Other NIST-Approved Algorithms](https://eprint.iacr.org/2023/331)

[SHA-3 Buffer Overflow](https://mouha.be/sha-3-buffer-overflow/)

[NVD - CVE-2022-37454](https://nvd.nist.gov/vuln/detail/CVE-2022-37454)

[CWE - CWE-190: Integer Overflow or Wraparound (4.13)](https://cwe.mitre.org/data/definitions/190.html)