# Type Confusion WebKit Vulunerability in iOS

## 작성자

이연제

## 발생일자

2021.05.03

## Summary

Apple이 iOS와 macOS의 Safari 브라우저에서 사용하는 WebKit에 **Type Confusion** 취약점이 발견됐는데 이와 관련된 악용 사례가 발생했다. 발생 당시에는 Apple측에서는 해당 버그를 직접적으로 수정하는 대신 패치갭에 간접적으로 기여했으며 현재에는 패치가 되었다.

## Keyword

#TypeConfusion #Apple #patch-gap #WebKit #CVE-2021-30665

## Root Cause

해당 버그는 **AudioWorklet**와 관련있는데 해당 기능은 Web Audio API의 인터페이스로 오디오 스크립트를 처리하는 데 사용된다. AudioWorklet을 사용하면 사용자는 WebKit을 사용하는 Safari 및 기타 브라우저에서 오디오 출력을 관리할 수 있게 된다.

이전에는 `ScriptProcessorNode` Javascript에서 오디오 데이터에 대한 임의의 계산을 허용하는 API가 도입됐었는데 해당 노드는 Javascript가 기본 스레드에서 실행되기 때문에 복잡한 오디오 처리 시 웹이 응답하지 않을 수 있었다. <br>
AudioWorklets은 해당 문제를 다양한 오디오 프로세스를 등록하는 Javascript 모듈을 전달함으로써 해결했다.

```javascript
// test-processor.js
class TestProcessor extends AudioWorkletProcessor {
  process(inputs, outputs, parameters) {
    // perform arbitrary computation here
    return true;
  }
}

registerProcessor("test-processor", TestProcessor);
```

전달되면 메인 스레드는 off-thread 프로세서가 지원하는 오디오 노드를 인스턴스화 할 수 있다. (off-thread : 특정 작업이나 프로세스가 메인 스레드 또는 메인 실행 경로에서 분리되어 별도의 스레드에서 실행될 때를 지칭. 예를 들어, 웹 브라우저에서 웹 페이지를 로딩하는 동안 사용자는 여전히 스크롤이나 다른 탭을 이용할 수 있어야 함. 이를 위해 브라우저는 웹 페이지 로딩과 같은 리소스 집약적인 작업을 메인 스레드가 아닌 다른 스레드에서 처리함. 이렇게 하면 메인 스레드가 사용자 인터페이스(UI)와 상호작용을 계속 유지할 수 있으며, "UI가 먹통이 되었다"거나 "응답하지 않는다"는 사용자의 경험을 방지할 수 있음.)

```javascript
await audioContext.audioWorklet.addModule("test-processor.js");
const node = new AudioWorkletNode(audioContext, "test-processor");
```

### 버그

새로운 AudioWorkletNode를 생성하기 위해선 메인 스레드는 주어진 프로세서 이름에 대해 등록된 생성자를 호출하도록 AudioWorklet 스레드에 작업을 게시한다. 해당 생성자는 AudioWorkletProcessor 타입의 객체를 반환할 것으로 예상되지만, 이는 명시적으로 확인되지 않는다. **Type Confusion**

```javascript
RefPtr<AudioWorkletProcessor> AudioWorkletGlobalScope::createProcessor(const String& name, TransferredMessagePort port, Ref<SerializedScriptValue>&& options)
{
    ...
    auto* object = JSC::construct(globalObject, jsConstructor, args, "Failed to construct AudioWorkletProcessor");
    ASSERT(!!scope.exception() == !object);
    RETURN_IF_EXCEPTION(scope, nullptr);

    // 문제 코드
    auto& jsProcessor = *JSC::jsCast<JSAudioWorkletProcessor*>(object);
    jsProcessor.wrapped().setProcessCallback(makeUnique<JSCallbackDataStrong>(&jsProcessor, globalObject));

    return &jsProcessor.wrapped();
}
```

위의 코드에서 `object`는 주어진 프로세서 생성자에 의해 반환된 Javascript 객체를 가리키는데 이는 `JSAudioWorkletProcessor`로 캐스팅되어 다양한 방식으로 접근 가능한데 이로 인해 충돌이 발생할 수 있다.

```javascript
registerProcessor(
  "test-processor",
  class {
    constructor() {
      return { foo: "bar" };
    }
  }
);
```

PoC(Proof-of-concept, 개념증명, 해당 개념을 도입하기 전 검증하기 위한 과정으로, 주요 단계로는 프로토타입 및 배포, 검증, 실현 여부 판단, 컨셉 조정 및 재진행이 있다.)으로 위의 코드를 실행한다면 AudioWorkletProcessor의 인스턴스가 아닌 일반 객체를 가리키게 되고 이는 JSAudioWorkletProcessor로 캐스팅되거나 오디오 프로세싱을 접근할 떄 의도하지 않은 결과를 도출할 수 있다.

### Patch code

```javascript
auto* jsProcessor = JSC::jsDynamicCast<JSAudioWorkletProcessor*>(vm, object);
    if (!jsProcessor)
        return nullptr;

    jsProcessor->wrapped().setProcessCallback(makeUnique<JSCallbackDataStrong>(jsProcessor, globalObject));

    return &jsProcessor->wrapped();
```

## Exploit

> **main idea** <br>
> 메모리 내에서 필드가 혼돈된 타입과 유용하게 겹치는 객체 타입을 찾아 이용

해당 버그를 악용하기 위해서는 메모리에서의 자바스크립트 객체의 레이아웃을 이해해야한다. [The_Butterfly_of_JSObject](https://liveoverflow.com/the-butterfly-of-jsobject-browser-0x02/)

애플은 bmalloc 할당자를 통해 메모리를 관리하고, 해당 할당자는 몇 개의 힙을 유지하는데 이 중 일부는 Gigacage(가상 메모리에 예약된 32GB 영역에서 할당 진행, 이는 사용자의 민감 데이터를 보호하기 위한 사용자 데이터 배열 저장하는 객체들에 사용됨) 방식으로 관리된다.

**즉, 메모리 상 객체를 조작하여 원하는 위치의 값을 덮어쓰게 하여 악용할 수 있다.**

## References

[Theori](https://blog.theori.io/patch-gapping-a-safari-type-confusion-b31e517d4cdd)

[spiceworks](https://www.spiceworks.com/it-security/vulnerability-management/news/type-confusion-webkit-vulnerability-in-ios-has-been-open-for-exploitation-for-weeks-despite-an-available-patch/)

[apple](https://support.apple.com/ko-kr/103067)

[TypeConfusion](https://hacksms.tistory.com/280)

[WebKit_Github](https://github.com/WebKit/WebKit/commit/d56afe6836db40cdea22eaa6b47c56a6197a8bab)

[WebKit_RCE_on_iOS14.1](https://gist.github.com/ujin5/6b9a32eedc5a39d714a3a72f06efffe5)

[PoC](https://tech1.tistory.com/43)
