# ****JetBrains TeamCity ì¸ì¦ ìš°íšŒ ì·¨ì•½ì ****

### Author

---

ê¹€ìˆœìš±

### Date

---

2023.09.21

### Summary

---

**JetBrain**ì—ì„œ On-Premise(Server) ë²„ì „ì˜ Windows OS ê¸°ë°˜ **Teamcity** ì†Œí”„íŠ¸ì›¨ì–´ì— í¬ë¦¬í‹°ì»¬í•œ **ì¸ì¦ ìš°íšŒ ì·¨ì•½ì **(`CVE-2023-42793`)ì´ ë°œê²¬ë˜ì—ˆìŒì„ ì•Œë ¸ë‹¤. ì´ ì·¨ì•½ì ì„ í†µí•´ ì ‘ê·¼ ê¶Œí•œì´ ì—†ëŠ” ê³µê²©ìê°€ TeamCity ì„œë²„ì— HTTP(S) ìš”ì²­ì„ í†µí•œ **RCE ê³µê²©**ì„ ìˆ˜í–‰í•˜ì—¬ ì„œë²„ ê´€ë¦¬ì ê¶Œí•œì„ ì–»ì„ ìˆ˜ ìˆìœ¼ë©°, ì·¨ì•½í•œ ë²„ì „ì¸ ê²½ìš° ì‚¬ìš©ìì˜ íŠ¹ì • í–‰ë™ì„ ìœ ë°œí•  í•„ìš”ê°€ ì—†ì–´ ìµìŠ¤í”Œë¡œì‡ ë‚œì´ë„ ë˜í•œ ë§¤ìš° ì‰½ë‹¤. CVSS ì ìˆ˜ ë˜í•œ **9.8**ë¡œ ê·¸ ì‹¬ê°ì„±ì„ ì•Œ ìˆ˜ ìˆë‹¤. ë¶í•œ í•´ì»¤ ì¡°ì§ë“¤ì€ 2023ë…„ 10ì›” ì´ˆë¶€í„° ì´ ì·¨ì•½ì ì„ ì•…ìš©í•´ ë‹¤ìˆ˜ì˜ TeamCity ì„œë²„ë¥¼ ê³µê²©í•´ì™”ë‹¤ê³  í•œë‹¤.

### Keywords

---

#CVE-2023-42793 #JetBrains #TeamCity #Authentication_Bypass_Vulnerability #RCE #CWE-288

### Root Cause

---

`CVE-2023-42793` ì·¨ì•½ì ì€ **ì¸ì¦ ìš°íšŒ ì·¨ì•½ì **(**CWE-288**)ìœ¼ë¡œ, â€œ`RequestInterceptors.java`â€ íŒŒì¼ì—ì„œ ë°œê²¬ë˜ì—ˆë‹¤. TeamCityëŠ” ëª¨ë“  HTTP ìš”ì²­ì— ëŒ€í•´ íŠ¹ì • ì‘ì—…ì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•´ request interceptorë¥¼ ì‚¬ìš©í•˜ëŠ”ë°, ì´ ì¸í„°ì…‰í„°ë“¤ì„ ì ìš©í•˜ëŠ” ì—­í• ì„ í•˜ëŠ” í´ë˜ìŠ¤ê°€ ë°”ë¡œ `RequestInterceptors`ë‹¤. 

```java
// RequestInterceptors.java

public final boolean preHandle(HttpServletRequest req, ...) {
    if (!this.requestPreHandlingAllowed(req)) {
        return true;
    }
    // ...
}

// ...

private boolean requestPreHandlingAllowed(@NotNull HttpServletRequest req) {
    // ...
    if (!this.myPreHandlingDisabled.matches(WebUtil.getPathWithoutContext(req))) {
        return true;
    }
    // path matches myPreHandlingDisabled? no pre-handling!
    return false;
}
```

ìš”ì²­ì„ ë°›ìœ¼ë©´ ì´ í´ë˜ìŠ¤ì˜ `preHandle` ë©”ì„œë“œê°€ í˜¸ì¶œë˜ë©°, ì´ ë©”ì„œë“œëŠ” `requestPreHandlingAllowed`ë¥¼ í˜¸ì¶œí•˜ì—¬ í•´ë‹¹ ìš”ì²­ì´ ì „ì²˜ë¦¬ì— ì í•©í•œì§€ ì—¬ë¶€ë¥¼ ê²°ì •í•œë‹¤.

`requestPreHandlingAllowed` ë©”ì„œë“œëŠ” ìš”ì²­ëœ ê²½ë¡œê°€ ë¯¸ë¦¬ ì •ì˜ëœ ê²½ë¡œ ì‹ ëª©ë¡(`myPreHandlingDisabled`)ê³¼ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸í•œë‹¤. ì¼ì¹˜í•˜ëŠ” ê²½ìš° ì „ì²˜ë¦¬ë¥¼ ì ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.

```java
// RequestInterceptors.java

public RequestInterceptors(@NotNull List<HandlerInterceptor> var1) {
    // ...
    this.myPreHandlingDisabled.addPath("/**" + XmlRpcController.getPathSuffix());
    this.myPreHandlingDisabled.addPath("/app/agents/**");
}

// XmlRpcController.java

public class XmlRpcController extends AbstractController {
    public static String getPathSuffix() {
        return "/RPC2";
    }
    // ...
}
```

`RequestInterceptors`ì˜ ìƒì„±ìì—ì„œ ë‘ ê°œì˜ ê²½ë¡œ ì‹ì„ ì¶”ê°€í•˜ëŠ”ë°, ì´ ì‹ë“¤ì€ ì „ì²˜ë¦¬ ê³¼ì •ì—ì„œ ì œì™¸ëœë‹¤. ì²« ë²ˆì§¸ ê²½ë¡œ í‘œí˜„ì‹ì€ â€œ`/**`â€ë¡œ ì‹œì‘í•˜ì—¬ `XmlRpcController.getPathSuffix()`ì˜ ë°˜í™˜ê°’(`â€œ/RPC2â€`)ìœ¼ë¡œ ì´ì–´ì ¸ ê²°ê³¼ì ì¸ ê²½ë¡œ í‘œí˜„ì‹ì€ `"/**/RPC2â€`ì´ë‹¤. ì´ í‘œí˜„ì‹ê³¼ ì¼ì¹˜í•˜ëŠ” ê²½ë¡œì— ëŒ€í•œ ìš”ì²­ì— ëŒ€í•´ì„œëŠ” ì „ì²˜ë¦¬ ì¸í„°ì…‰í„°ê°€ ì ìš©ë˜ì§€ ì•Šìœ¼ë©°, ì´ëŠ” ê¶Œí•œ ê²€ì‚¬ê°€ ìˆ˜í–‰ë˜ì§€ ì•ŠìŒì„ ì˜ë¯¸í•œë‹¤. ì´ ìˆ˜ì‹ì€ ë‘ ê°œì˜ ë³„í‘œ(`â€/**/â€`)ë¡œ ì¸í•´ ìš”ì²­ëœ ê²½ë¡œì˜ ì„ì˜ ì ‘ë‘ì‚¬ë¥¼ í—ˆìš©í•˜ë¯€ë¡œ ìœ„í—˜í•˜ë‹¤. ì´ë ‡ê²Œ í•˜ë©´ `/RPC`ë¡œ ëë‚˜ëŠ” ê²½ë¡œì— ëŒ€í•œ ëª¨ë“  ìš”ì²­ì— ëŒ€í•œ ê¶Œí•œ ê²€ì‚¬ê°€ íš¨ê³¼ì ìœ¼ë¡œ ë¹„í™œì„±í™”ëœë‹¤.

TeamCityëŠ” ì™¸ë¶€ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ í†µí•©í•˜ê¸° ìœ„í•œ REST APIë¥¼ ì œê³µí•˜ëŠ”ë°, ì—”ë“œ í¬ì¸íŠ¸ë“¤ ì¤‘ í•˜ë‚˜ëŠ” `/app/rest/users/<userLocator>/token` ê²½ë¡œë¥¼ í†µí•´ ì‚¬ìš©ì ì¸ì¦ í† í°ì„ ìƒì„±í•  ìˆ˜ ìˆë‹¤. ê·¸ëŸ¬ë‚˜ ì´ ê²½ë¡œëŠ” â€œ/tokenâ€ì´ë¼ëŠ” ì ‘ë¯¸ì‚¬ë¡œ ëë‚˜ ì¸ì¦ì„ ìš°íšŒí•˜ëŠ”ë° ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤.

```java
// UserRequest.java

@Api("User")
@Path(UserRequest.API_USERS_URL)
public class UserRequest {
    // ...
    @Path("/{userLocator}/tokens/{name}")
    @ApiOperation(value = "Create a new authentication token for the matching user.", nickname = "addUserToken", hidden = true)
    @POST
    @Produces({"application/xml", "application/json"})
    public Token createToken(@PathParam("userLocator") @ApiParam(format = "UserLocator") String userLocator, @PathParam("name") @NotNull String name, ...) {
        // ...
        SUser user = this.myUserFinder.getItem(userLocator, true);
        AuthenticationToken token = tokenAuthenticationModel.createToken(user.getId(), name, ...);
        return new Token(token, ...);
    }
}
```

í•˜ì§€ë§Œ ì´ ì½”ë“œëŠ” í† í° ìƒì„± ì—”ë“œí¬ì¸íŠ¸ì˜ ë‹¤ë¥¸ ë²„ì „ì¸ë°, ì‚¬ìš©ì ì¸ì¦ í† í°ì„ ìƒì„±í•˜ë©´ì„œ ì¶”ê°€ì ìœ¼ë¡œ `{name}` ìš”ì²­ ë§¤ê°œë³€ìˆ˜ë¥¼ í†µí•´ í† í°ì˜ ì´ë¦„ì„ ì œê³µí•  ìˆ˜ ìˆë‹¤. ì´ ì´ë¦„ì€ ì„ì˜ë¡œ ì„¤ì •í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ `RPC2`ê°€ ìœ íš¨í•˜ë‹¤ê³  ê°„ì£¼ëœë‹¤.

ë”°ë¼ì„œ ê¶Œí•œì´ ì—†ëŠ” ê³µê²©ìëŠ” ë‹¤ìŒê³¼ ê°™ì€ POST ìš”ì²­ì„ ì´ìš©í•´ ëª¨ë“  ì‚¬ìš©ìì— ëŒ€í•œ ìƒˆ ì¸ì¦ í† í°ì„ ë§Œë“¤ ìˆ˜ ìˆë‹¤.

> POST /app/rest/users/id:1/token/RPC2
> 

í˜„ì¬ ì´ ì·¨ì•½ì ì€ íŒ¨ì¹˜ë˜ì—ˆìœ¼ë©°, íŒ¨ì¹˜ ë‚´ì—­ì„ ë¹„êµ í™•ì¸í•´ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì´ ë¬¸ì œê°€ ëœ â€œ`/**`â€ ë¶€ë¶„ì„ ì—†ì•¤ ì½”ë“œë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

![íŒ¨ì¹˜ ë‚´ì—­](https://github.com/IHHH-official/Vulnerability-Research/assets/48719589/27c179c8-d323-4e17-887e-4f8cba6fa332)

### Exploit

---

íŠ¹íˆ ì´ ì·¨ì•½ì ì€ ë¶í•œì˜ í•´ì»¤ ì¡°ì§ì¸ Lazarus ê·¸ë£¹ì— ì†Œì†ëœ **Diamond Sleet**(ì¼ëª… Labyrinth Chollima)ê³¼ **Onyx Sleet**(ì¼ëª… Andariel)ì— ì˜í•´ ì ê·¹ì ìœ¼ë¡œ ì•…ìš©ë˜ê³  ìˆë‹¤. íŠ¹ì´í•œ ì ì€ ë‘ ì¡°ì§ì´ ê°™ì€ ì·¨ì•½ì ì„ ì´ìš©í•˜ë©´ì„œë„ ì´í›„ ì„œë²„ë¥¼ ì¥ì•…í•˜ëŠ” ë“±ì˜ ê³µê²©ì„ ì „ê°œí•˜ëŠ” ë°©ì‹ì´ ë‹¤ë¥´ë‹¤ëŠ” ì ì´ë‹¤.

![Diamond Sleet: ForestTiger ë°±ë„ì–´ë¥¼ ì´ìš©í•œ ê³µê²©ì²´ì¸](https://github.com/IHHH-official/Vulnerability-Research/assets/48719589/4becb2a9-ce83-48af-aa09-942388acb51a)

Diamond Sleet: ForestTiger ë°±ë„ì–´ë¥¼ ì´ìš©í•œ ê³µê²©ì²´ì¸

**Diamond Sleet**ì˜ ê²½ìš° 2ê°€ì§€ ê³µê²©ì²´ì¸ì´ ì¡´ì¬í•˜ëŠ”ë°, ì²« ë²ˆì§¸ëŠ” **ForestTiger** ë°±ë„ì–´ë¥¼ ì„¤ì¹˜í•˜ëŠ” ê²ƒì´ë‹¤. ê³µê²©ìëŠ” ì„±ê³µì ìœ¼ë¡œ ì„œë²„ë¥¼ ì†ìƒì‹œí‚¨ í›„ ForestTigerë¼ëŠ” ì„í”Œë€íŠ¸ë¥¼ ì„¤ì¹˜í•œë‹¤. ê³µê²©ìê°€ ì´ì „ì— ì†ìƒì‹œí‚¨ í•©ë²•ì ì¸ ì´í”„ë¼ì—ì„œ ì´ ì„í”Œë€íŠ¸ê°€ ë¡œë“œë˜ê¸° ë•Œë¬¸ì— ì¹¨ì…ì„ íƒì§€í•˜ê²Œ ì–´ë µê²Œ ë§Œë“ ë‹¤.

![Diamond Sleet: DLL search order hijackingì„ ì´ìš©í•œ ê³µê²©ì²´ì¸](https://github.com/IHHH-official/Vulnerability-Research/assets/48719589/205287b1-be08-4e21-8bac-f3ca71b38f21)

Diamond Sleet: DLL search order hijackingì„ ì´ìš©í•œ ê³µê²©ì²´ì¸

ë‘ ë²ˆì§¸ ê³µê²©ì€ **DLL search-order í•˜ì´ì¬í‚¹**ì„ ì´ìš©í•œ ê³µê²©ì´ë‹¤. ì´ ê¸°ìˆ ì„ ì´ìš©í•´ ì•…ì„± DLLì„ ë¡œë“œí•˜ëŠ”ë°, ê³µê²©ìëŠ” ë‹¤ìŒ ë‹¨ê³„ í˜ì´ë¡œë“œë¥¼ ì‹¤í–‰í•˜ê±°ë‚˜ ì›ê²© ì•¡ì„¸ìŠ¤ íŠ¸ë¡œì´ ëª©ë§ˆ(RAT)ë¥¼ ë°°í¬í•  ìˆ˜ ìˆë‹¤.

![Onyx Sleet: ìœ ì € ê³„ì • ìƒì„±ì„ ì´ìš©í•œ ê³µê²©ì²´ì¸](https://github.com/IHHH-official/Vulnerability-Research/assets/48719589/58876446-3e1c-4235-ab9d-ce4e812b8f15)

Onyx Sleet: ìœ ì € ê³„ì • ìƒì„±ì„ ì´ìš©í•œ ê³µê²©ì²´ì¸

**Onyx Sleet**ì€ ë‹¤ë¥¸ ì ‘ê·¼ ë°©ì‹ì„ ì·¨í•œë‹¤. ê³µê²©ìëŠ” â€œ`krtbgt`â€ë¼ëŠ” ìƒˆ ìœ ì € ê³„ì •ì„ ìƒì„±í•˜ê³ (Kerberos Ticket Granting Ticketì˜ ì‚¬ì¹­) â€œ`net use`â€ ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ ì´ ê³„ì •ì„ ë¡œì»¬ ê´€ë¦¬ì ê·¸ë£¹ì— ì¶”ê°€í•œë‹¤. ì´í›„ ê³µê²©ìëŠ” ì†ìƒëœ ì‹œìŠ¤í…œì—ì„œ ì‹œìŠ¤í…œ ê²€ìƒ‰ ëª…ë ¹ì„ ì‹¤í–‰í•˜ì—¬ â€œHazyLoadâ€ë¼ëŠ” ì‚¬ìš©ì ì§€ì • í”„ë¡ì‹œ ë„êµ¬ë¥¼ ë°°í¬í•´ ì†ìƒëœ ì„œë²„ì™€ ê³µê²©ìì˜ ì¸í”„ë¼ ì‚¬ì´ì˜ ì§€ì†ì ì¸ ì—°ê²°ì„ ì„¤ì •í•œë‹¤. ì´ë¥¼ í†µí•´ LSASS ë©”ëª¨ë¦¬, ë¸Œë¼ìš°ì € ë°ì´í„° ë“±ì„ í¬í•¨í•œ ë‹¤ì–‘í•œ í¬ë¦¬ë´ì…œì„ ì¶”ì¶œí•˜ê±°ë‚˜ ì¶”ê°€ì ì¸ ê³µê²©ì´ ê°€ëŠ¥í•´ì§„ë‹¤. ì´ë•Œ ê³µê²©ìëŠ” ì›ê²© ë°ìŠ¤í¬í†± í”„ë¡œí† ì½œ(RDP)ì„ í†µí•´ ë¡œê·¸ì¸í•˜ê³  TeamCity ì„œë¹„ìŠ¤ë¥¼ ì¢…ë£Œí•˜ê¸° ìœ„í•´ â€œ`krtbgt`â€ ê³„ì •ì„ ì‚¬ìš©í•˜ëŠ”ë°, ì´ëŠ” ë‹¤ë¥¸ ê³µê²©ìì˜ ì•¡ì„¸ìŠ¤ë¥¼ ì°¨ë‹¨í•˜ê¸° ìœ„í•œ ê²ƒì´ë‹¤.

### Reference

---

[2023 HotğŸ”¥ ë³´ì•ˆ ì‚¬ê±´ ì‚¬ê³ â€Šâ€”â€Ší•˜ë°˜ê¸°](https://blog.theori.io/2023-h2-hot-security-issue-case-ec54369d1886)

[Critical Security Issue Affecting TeamCity On-Premises â€“ Update to 2023.05.4 Now | The TeamCity Blog](https://blog.jetbrains.com/teamcity/2023/09/critical-security-issue-affecting-teamcity-on-premises-update-to-2023-05-4-now/)

[NVD - CVE-2023-42793](https://nvd.nist.gov/vuln/detail/CVE-2023-42793)

[CWE - CWE-288: Authentication Bypass Using an Alternate Path or Channel (4.13)](https://cwe.mitre.org/data/definitions/288.html)

[ì„œë²„ë¥¼ ë³´í˜¸í•˜ì„¸ìš”: JetBrains TeamCity ê²°í•¨ ê²½ê³ ](https://tuxcare.com/ko/blog/jetbrains-teamcity-flaw-alert/)

[Source Code at Risk: Critical Code Vulnerability in CI/CD Platform TeamCity](https://www.sonarsource.com/blog/teamcity-vulnerability/?ref=blog.projectdiscovery.io)