# ****JetBrains TeamCity 인증 우회 취약점****

### Author

---

김순욱

### Date

---

2023.09.21

### Summary

---

**JetBrain**에서 On-Premise(Server) 버전의 Windows OS 기반 **Teamcity** 소프트웨어에 크리티컬한 **인증 우회 취약점**(`CVE-2023-42793`)이 발견되었음을 알렸다. 이 취약점을 통해 접근 권한이 없는 공격자가 TeamCity 서버에 HTTP(S) 요청을 통한 **RCE 공격**을 수행하여 서버 관리자 권한을 얻을 수 있으며, 취약한 버전인 경우 사용자의 특정 행동을 유발할 필요가 없어 익스플로잇 난이도 또한 매우 쉽다. CVSS 점수 또한 **9.8**로 그 심각성을 알 수 있다. 북한 해커 조직들은 2023년 10월 초부터 이 취약점을 악용해 다수의 TeamCity 서버를 공격해왔다고 한다.

### Keywords

---

#CVE-2023-42793 #JetBrains #TeamCity #Authentication_Bypass_Vulnerability #RCE #CWE-288

### Root Cause

---

`CVE-2023-42793` 취약점은 **인증 우회 취약점**(**CWE-288**)으로, “`RequestInterceptors.java`” 파일에서 발견되었다. TeamCity는 모든 HTTP 요청에 대해 특정 작업을 수행하기 위해 request interceptor를 사용하는데, 이 인터셉터들을 적용하는 역할을 하는 클래스가 바로 `RequestInterceptors`다. 

```java
// RequestInterceptors.java

public final boolean preHandle(HttpServletRequest req, ...) {
    if (!this.requestPreHandlingAllowed(req)) {
        return true;
    }
    // ...
}

// ...

private boolean requestPreHandlingAllowed(@NotNull HttpServletRequest req) {
    // ...
    if (!this.myPreHandlingDisabled.matches(WebUtil.getPathWithoutContext(req))) {
        return true;
    }
    // path matches myPreHandlingDisabled? no pre-handling!
    return false;
}
```

요청을 받으면 이 클래스의 `preHandle` 메서드가 호출되며, 이 메서드는 `requestPreHandlingAllowed`를 호출하여 해당 요청이 전처리에 적합한지 여부를 결정한다.

`requestPreHandlingAllowed` 메서드는 요청된 경로가 미리 정의된 경로 식 목록(`myPreHandlingDisabled`)과 일치하는지 확인한다. 일치하는 경우 전처리를 적용하지 않는다.

```java
// RequestInterceptors.java

public RequestInterceptors(@NotNull List<HandlerInterceptor> var1) {
    // ...
    this.myPreHandlingDisabled.addPath("/**" + XmlRpcController.getPathSuffix());
    this.myPreHandlingDisabled.addPath("/app/agents/**");
}

// XmlRpcController.java

public class XmlRpcController extends AbstractController {
    public static String getPathSuffix() {
        return "/RPC2";
    }
    // ...
}
```

`RequestInterceptors`의 생성자에서 두 개의 경로 식을 추가하는데, 이 식들은 전처리 과정에서 제외된다. 첫 번째 경로 표현식은 “`/**`”로 시작하여 `XmlRpcController.getPathSuffix()`의 반환값(`“/RPC2”`)으로 이어져 결과적인 경로 표현식은 `"/**/RPC2”`이다. 이 표현식과 일치하는 경로에 대한 요청에 대해서는 전처리 인터셉터가 적용되지 않으며, 이는 권한 검사가 수행되지 않음을 의미한다. 이 수식은 두 개의 별표(`”/**/”`)로 인해 요청된 경로의 임의 접두사를 허용하므로 위험하다. 이렇게 하면 `/RPC`로 끝나는 경로에 대한 모든 요청에 대한 권한 검사가 효과적으로 비활성화된다.

TeamCity는 외부 애플리케이션을 통합하기 위한 REST API를 제공하는데, 엔드 포인트들 중 하나는 `/app/rest/users/<userLocator>/token` 경로를 통해 사용자 인증 토큰을 생성할 수 있다. 그러나 이 경로는 “/token”이라는 접미사로 끝나 인증을 우회하는데 사용할 수 없다.

```java
// UserRequest.java

@Api("User")
@Path(UserRequest.API_USERS_URL)
public class UserRequest {
    // ...
    @Path("/{userLocator}/tokens/{name}")
    @ApiOperation(value = "Create a new authentication token for the matching user.", nickname = "addUserToken", hidden = true)
    @POST
    @Produces({"application/xml", "application/json"})
    public Token createToken(@PathParam("userLocator") @ApiParam(format = "UserLocator") String userLocator, @PathParam("name") @NotNull String name, ...) {
        // ...
        SUser user = this.myUserFinder.getItem(userLocator, true);
        AuthenticationToken token = tokenAuthenticationModel.createToken(user.getId(), name, ...);
        return new Token(token, ...);
    }
}
```

하지만 이 코드는 토큰 생성 엔드포인트의 다른 버전인데, 사용자 인증 토큰을 생성하면서 추가적으로 `{name}` 요청 매개변수를 통해 토큰의 이름을 제공할 수 있다. 이 이름은 임의로 설정할 수 있으므로 `RPC2`가 유효하다고 간주된다.

따라서 권한이 없는 공격자는 다음과 같은 POST 요청을 이용해 모든 사용자에 대한 새 인증 토큰을 만들 수 있다.

> POST /app/rest/users/id:1/token/RPC2
> 

현재 이 취약점은 패치되었으며, 패치 내역을 비교 확인해보면 다음과 같이 문제가 된 “`/**`” 부분을 없앤 코드를 확인할 수 있다.

![패치 내역](https://github.com/IHHH-official/Vulnerability-Research/assets/48719589/27c179c8-d323-4e17-887e-4f8cba6fa332)

### Exploit

---

특히 이 취약점은 북한의 해커 조직인 Lazarus 그룹에 소속된 **Diamond Sleet**(일명 Labyrinth Chollima)과 **Onyx Sleet**(일명 Andariel)에 의해 적극적으로 악용되고 있다. 특이한 점은 두 조직이 같은 취약점을 이용하면서도 이후 서버를 장악하는 등의 공격을 전개하는 방식이 다르다는 점이다.

![Diamond Sleet: ForestTiger 백도어를 이용한 공격체인](https://github.com/IHHH-official/Vulnerability-Research/assets/48719589/4becb2a9-ce83-48af-aa09-942388acb51a)

Diamond Sleet: ForestTiger 백도어를 이용한 공격체인

**Diamond Sleet**의 경우 2가지 공격체인이 존재하는데, 첫 번째는 **ForestTiger** 백도어를 설치하는 것이다. 공격자는 성공적으로 서버를 손상시킨 후 ForestTiger라는 임플란트를 설치한다. 공격자가 이전에 손상시킨 합법적인 이프라에서 이 임플란트가 로드되기 때문에 침입을 탐지하게 어렵게 만든다.

![Diamond Sleet: DLL search order hijacking을 이용한 공격체인](https://github.com/IHHH-official/Vulnerability-Research/assets/48719589/205287b1-be08-4e21-8bac-f3ca71b38f21)

Diamond Sleet: DLL search order hijacking을 이용한 공격체인

두 번째 공격은 **DLL search-order 하이재킹**을 이용한 공격이다. 이 기술을 이용해 악성 DLL을 로드하는데, 공격자는 다음 단계 페이로드를 실행하거나 원격 액세스 트로이 목마(RAT)를 배포할 수 있다.

![Onyx Sleet: 유저 계정 생성을 이용한 공격체인](https://github.com/IHHH-official/Vulnerability-Research/assets/48719589/58876446-3e1c-4235-ab9d-ce4e812b8f15)

Onyx Sleet: 유저 계정 생성을 이용한 공격체인

**Onyx Sleet**은 다른 접근 방식을 취한다. 공격자는 “`krtbgt`”라는 새 유저 계정을 생성하고(Kerberos Ticket Granting Ticket의 사칭) “`net use`” 명령을 사용하여 이 계정을 로컬 관리자 그룹에 추가한다. 이후 공격자는 손상된 시스템에서 시스템 검색 명령을 실행하여 “HazyLoad”라는 사용자 지정 프록시 도구를 배포해 손상된 서버와 공격자의 인프라 사이의 지속적인 연결을 설정한다. 이를 통해 LSASS 메모리, 브라우저 데이터 등을 포함한 다양한 크리덴셜을 추출하거나 추가적인 공격이 가능해진다. 이때 공격자는 원격 데스크톱 프로토콜(RDP)을 통해 로그인하고 TeamCity 서비스를 종료하기 위해 “`krtbgt`” 계정을 사용하는데, 이는 다른 공격자의 액세스를 차단하기 위한 것이다.

### Reference

---

[2023 Hot🔥 보안 사건 사고 — 하반기](https://blog.theori.io/2023-h2-hot-security-issue-case-ec54369d1886)

[Critical Security Issue Affecting TeamCity On-Premises – Update to 2023.05.4 Now | The TeamCity Blog](https://blog.jetbrains.com/teamcity/2023/09/critical-security-issue-affecting-teamcity-on-premises-update-to-2023-05-4-now/)

[NVD - CVE-2023-42793](https://nvd.nist.gov/vuln/detail/CVE-2023-42793)

[CWE - CWE-288: Authentication Bypass Using an Alternate Path or Channel (4.13)](https://cwe.mitre.org/data/definitions/288.html)

[서버를 보호하세요: JetBrains TeamCity 결함 경고](https://tuxcare.com/ko/blog/jetbrains-teamcity-flaw-alert/)

[Source Code at Risk: Critical Code Vulnerability in CI/CD Platform TeamCity](https://www.sonarsource.com/blog/teamcity-vulnerability/?ref=blog.projectdiscovery.io)