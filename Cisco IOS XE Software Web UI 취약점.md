# Cisco IOS XE Software Web UI 취약점

### Author

---

김순욱

### Date

---

2023.10.16

### Summary

---

**Cisco** 라우터 및 일부 스위치에서 사용되는 운영체제인 **IOS XE 소프트웨어**들에서 권한이 없는 사용자가 웹 관리자 권한 뿐 아니라 기기의 root 권한까지 탈취할 수 있는 크리티컬한 취약점들(`CVE-2023-20198`, `CVE-2023-20273`)이 발견되었다.

### Keywords

---

#CVE-2023-20198 #CVE-2023-20273 #Cisco #IOS_XE_software #Web_UI #Privllege_Escalation_Vulnerability #CSCwh87343

### Root Cause

---

`CVE-2023-20198` 취약점은 인증되지 않은 공격자가 가장 높은 수준의 접근 권한인 레벨 15 권한의 임의의 계정을 생성하여 시스템을 제어할 수 있으며, `CVE-2023-20273` 취약점은 명령어 주입을 수행하여 악의적인 내용을 파일 시스템에 쓸 수 있다. 각각 CVSS 점수 **10.0**과 **7.2**를 할당받았다.

![POC](https://github.com/IHHH-official/Vulnerability-Research/assets/48719589/3fe5c0f0-1899-414e-90fd-aef358ba981b)

POC

POC 코드는 위와 같다. baduser라는 이름의 레벨 15 권한의 유저를 생성한다.

이 코드에서 핵심은 바로 첫줄(`POST /%2577ebui_wsma_HTTP`)이다. 이는 바로 `webui_wsma_http`를 암호화한 것으로, 이를 통해 Nginx 일치를 우회하고 WSMA 서비스에 액세스할 수 있게 한다.

WSMA(Web Services Management Agent) 서비스를 사용하면 명령을 실행하고 SOAP 요청을 통해 시스템을 구성할 수 있다. 여기서 다음의 CLI 명령을 보내 15레벨 권한의 새 유저를 쉽게 만들 수 있다.

> username <user> privilege 15 secret <password>
> 

![새 유저인 baduser를 생성한 모습](https://github.com/IHHH-official/Vulnerability-Research/assets/48719589/bfc55e8b-80b3-4610-b79e-db42a311e0b1)

새 유저인 baduser를 생성한 모습

POC를 실행한 후, UI에서 Administration → User Administration에서 생성한 새 유저를 확인할 수 있다.

![패치된 코드](https://github.com/IHHH-official/Vulnerability-Research/assets/48719589/8329efc3-61f3-4d21-a982-76f446a2136e)

패치된 코드

Cisco에서 해당 취약점을 확인하고 이를 패치해 배포한 코드를 확인해보면, 패치된 `Proxy-Uri-Source` 헤더는 기본 헤더값(`webui_internal`)을 설정하여 위와 같은 공격자의 액세스를 방지한다.

Cisco IOS XE Software의 Web UI 기능이 활성화되어 있는 모든 장비들이 이 취약점들의 영향을 받는다. 예시처럼 다음 명령어들에 대한 결과가 하나 이상 나타난다면, Web UI 기능이 활성화 되어있다고  판단할 수 있다.

> Router# **show running-config | include ip http server|secure|active**
> 
> 
> ip http server
> 
> ip http secure-server
> 

### Exploit

---

`CVE-2023-20198` 취약점 공격을 성공하면, 공격자는 전체 관리자 권한으로 장치에 액세스할 수 있다. 디바이스를 손상시킨 후 공격자는 또다른 취약점인 `CVE-2023-20273`을 이용한다. 이를 통해 공격자는 상승된 권한으로 명령어 주입을 수행할 수 있게 되는데, 이때 파일 시스템에 **BadCandy** 임플란트를 쓸 수 있다.

BadCandy는 Lua 프로그래밍 언어 기반으로, 임의의 명령 실행을 용이하게 하는 다음과 같은 29줄의 코드로 구성되어있다.

![BadCandy 코드](https://github.com/IHHH-official/Vulnerability-Research/assets/48719589/68217f62-136f-4803-bbaf-752bc59eb8e4)

BadCandy 코드

공격자는 장치에 HTTP POST 요청을 생성하고, 다음의 세가지 기능을 제공한다.

1. 첫 번째 기능은 “`menu`” 매개변수에 의해 지시되는데, “/”로 둘러싸인 일련의 숫자를 반환하며, 임플란트 버전을 나타내는 것으로 보인다.
2. 두 번째 기능은 “`logon_hash`” 매개 변수에 의해 지시되며, 이 매개 변수는 “1”로 설정되어야 한다. 그러면 임플란트에 하드 코딩된 18자 16진수 문자열이 반환된다.
3. 세 번째 기능도 “`logon_hash`”와 “`common_type`” 매개 변수에 의해 지시된다. “`logon_hash`”는 임플란트에 하드 코딩된 40자 16진수 문자열과 일치하는지 확인하고, “`common_type`” 매개변수는 코드가 시스템 레벨(”`subsystem`”)에서 실행되는지, IOS 레벨(”`iox`”)에서 실행되는지 여부를 결정한다.

위 코드 외에도 핵심 기능은 동일하게 유지한 채 헤더에 대한 검사를 포함한 BadCandy의 다른 버전들을 이용하는 사례들도 확인되었다고 한다.

### Solution

---

해당 취약점 발견 직후에는 패치가 공개되지 않아 우선 다음 의사결정 트리에 따르도록 권고했다.

> Q. IOS XE를 사용하는가?
> 
> - 아니오 → 조치가 필요없음
> - 네
> 
> Q. `ip http server` 또는 `ip http secure-server`가 구성되어 있는가?
> 
> - 아니오 → 취약성을 악용할 수 없음, 조치 필요없음
> - 네
> 
> Q. HTTP/HTTPS 통신이 필요한 서비스(ex. eWLC)를 운영하는가?
> 
> - 아니오 → HTTP 서버 기능 비활성화
>     - HTTP 서버 사용 시: `no ip http server`
>     - HTTPS 서버 사용 시: `no ip http secure-server`
> - 네 → 서비스에 대한 액세스를 신뢰할 수 있는 네트워크로 제한

또한, 서버 재시작 시 또다른 멀웨어가 실행되거나 침해 지표(IOC)가 사라질 수 있어 재시작보다는 다른 서버와의 격리를 권고했다.

현재는 Cisco에서 배포한 최신 보안 패치(Bug ID: CSCwh87343)를 받아 해결 할 수 있다.

### Reference

---

[Cisco IOS XE Software Web UI 취약점 주의 (CVE-2023-20198, CVE-2023-20273) - ASEC BLOG](https://asec.ahnlab.com/ko/57951/)

[2023 Hot🔥 보안 사건 사고 — 하반기](https://blog.theori.io/2023-h2-hot-security-issue-case-ec54369d1886)

[Cisco Security Advisory: Multiple Vulnerabilities in Cisco IOS XE Software Web UI Feature](https://sec.cloudapps.cisco.com/security/center/content/CiscoSecurityAdvisory/cisco-sa-iosxe-webui-privesc-j22SaA4z)

[Software Fix Availability for Cisco IOS XE Software Web UI Privilege Escalation Vulnerability - CVE-2023-20198](https://www.cisco.com/c/en/us/support/docs/ios-nx-os-software/ios-xe-dublin-17121/221128-software-fix-availability-for-cisco-ios.html)

[Active exploitation of Cisco IOS XE Software Web Management User Interface vulnerabilities](https://blog.talosintelligence.com/active-exploitation-of-cisco-ios-xe-software/)